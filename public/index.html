<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PixelBoard</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      touch-action: none;
      border: 1px solid #ccc;
      image-rendering: pixelated;
    }
    #ui {
      margin: 10px;
    }
    #chatBox {
      width: 300px;
      height: 150px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
      background: #f8f8f8;
      font-size: 14px;
    }
    #chatInput, #nameInput {
      width: 240px;
      margin-top: 5px;
    }
    .cursor {
      position: absolute;
      pointer-events: none;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <h2>PixelBoard</h2>
  <div id="ui">
    Color: <input type="color" id="colorPicker" value="#ff0000">
    Size: <input type="number" id="brushSize" value="1" min="1" max="10">
    <button id="eraserBtn">Eraser</button>
    <input type="text" id="nameInput" placeholder="Your name">
  </div>

  <canvas id="canvas" width="1000" height="1000"></canvas>

  <div id="chatBox"></div>
  <input type="text" id="chatInput" placeholder="Type message and press Enter">

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const colorPicker = document.getElementById('colorPicker');
    const brushSizeInput = document.getElementById('brushSize');
    const eraserBtn = document.getElementById('eraserBtn');
    const nameInput = document.getElementById('nameInput');
    const chatBox = document.getElementById('chatBox');
    const chatInput = document.getElementById('chatInput');

    const socket = io();
    let drawing = false;
    let erasing = false;
    let name = '';

    const cursors = {};

    function drawPixel(x, y, color, size) {
      ctx.fillStyle = color;
      ctx.fillRect(x, y, size, size);
    }

    canvas.addEventListener('pointerdown', e => {
      drawing = true;
      drawAtEvent(e);
    });

    canvas.addEventListener('pointermove', e => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      socket.emit('cursor', { x, y });
      if (drawing) drawAtEvent(e);
    });

    canvas.addEventListener('pointerup', () => {
      drawing = false;
    });

    function drawAtEvent(e) {
      const rect = canvas.getBoundingClientRect();
      const x = Math.floor((e.clientX - rect.left));
      const y = Math.floor((e.clientY - rect.top));
      const size = parseInt(brushSizeInput.value);
      const color = erasing ? "#ffffff" : colorPicker.value;

      for (let dx = 0; dx < size; dx++) {
        for (let dy = 0; dy < size; dy++) {
          const px = x + dx;
          const py = y + dy;
          drawPixel(px, py, color, 1);
          socket.emit('draw_pixel', { x: px, y: py, color });
        }
      }
    }

    socket.on('init_pixels', pixels => {
      for (const key in pixels) {
        const { x, y, color } = pixels[key];
        drawPixel(x, y, color, 1);
      }
    });

    socket.on('draw_pixel', data => {
      drawPixel(data.x, data.y, data.color, 1);
    });

    socket.on('cursor', data => {
      let el = cursors[data.id];
      if (!el) {
        el = document.createElement('div');
        el.className = 'cursor';
        el.innerText = '🖌️ ' + data.name;
        document.body.appendChild(el);
        cursors[data.id] = el;
      }
      el.style.left = (data.x + canvas.offsetLeft + 10) + 'px';
      el.style.top = (data.y + canvas.offsetTop + 10) + 'px';
      el.style.color = data.color;
    });

    socket.on('remove_cursor', id => {
      if (cursors[id]) {
        document.body.removeChild(cursors[id]);
        delete cursors[id];
      }
    });

    eraserBtn.onclick = () => {
      erasing = !erasing;
      eraserBtn.style.backgroundColor = erasing ? "#ccc" : "";
    };

    nameInput.onchange = () => {
      name = nameInput.value;
      socket.emit('set_name', name);
    };

    chatInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && chatInput.value.trim()) {
        socket.emit('chat', chatInput.value.trim());
        chatInput.value = '';
      }
    });

    socket.on('chat', ({ name, msg }) => {
      const p = document.createElement('p');
      p.textContent = `${name}: ${msg}`;
      chatBox.appendChild(p);
      chatBox.scrollTop = chatBox.scrollHeight;
    });
  </script>
</body>
</html>
